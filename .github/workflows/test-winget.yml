name: Test Winget Manifest

on:
  pull_request:
    paths:
      - 'packaging/winget/**'
      - '.github/workflows/test-winget.yml'
  push:
    branches: [main]
    paths:
      - 'packaging/winget/**'
      - '.github/workflows/test-winget.yml'

jobs:
  validate-winget:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate manifest schema
        shell: pwsh
        run: |
          $testDir = "winget-validate-test"
          $testVersion = "0.0.1"
          $testHashX64 = "0000000000000000000000000000000000000000000000000000000000000001"
          $testHashArm64 = "0000000000000000000000000000000000000000000000000000000000000002"

          New-Item -ItemType Directory -Path $testDir -Force | Out-Null

          # Process version manifest
          $content = Get-Content "packaging/winget/OpenCLICollective.gmail-readonly.yaml" -Raw
          $content = $content -replace "0\.0\.0", $testVersion
          Set-Content "$testDir/OpenCLICollective.gmail-readonly.yaml" $content -Encoding UTF8

          # Process locale manifest
          $content = Get-Content "packaging/winget/OpenCLICollective.gmail-readonly.locale.en-US.yaml" -Raw
          $content = $content -replace "0\.0\.0", $testVersion
          Set-Content "$testDir/OpenCLICollective.gmail-readonly.locale.en-US.yaml" $content -Encoding UTF8

          # Process installer manifest (version + checksums)
          $content = Get-Content "packaging/winget/OpenCLICollective.gmail-readonly.installer.yaml" -Raw
          $content = $content -replace "0\.0\.0", $testVersion
          # Replace first checksum (x64)
          $content = $content -replace "0{64}", $testHashX64, 1
          # Replace second checksum (arm64)
          $content = $content -replace "0{64}", $testHashArm64
          Set-Content "$testDir/OpenCLICollective.gmail-readonly.installer.yaml" $content -Encoding UTF8

          Write-Host "Generated test manifests:"
          Get-ChildItem $testDir | ForEach-Object { Write-Host "  $_" }

          Write-Host "`nValidating winget manifest schema..."
          winget validate --manifest $testDir/
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Manifest schema validation failed"
            exit 1
          }
          Write-Host "Manifest schema validation passed!"
